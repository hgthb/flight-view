<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radar Live View</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #0b0f19; color: white; margin: 0; padding: 5px; }
        * { box-sizing: border-box; }
        h2 { text-align: center; color: #00d4ff; font-size: 1.1rem; margin: 6px 0; display: flex; justify-content: center; align-items: center; gap: 8px; }
        
        .summary-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; padding: 0 2px; }
        .total-text { font-size: 13px; color: #facc15; font-weight: bold; }
        .update-time { font-size: 10px; color: #94a3b8; font-style: italic; }

        .table-wrapper { background: #161b22; border-radius: 8px; border: 1px solid #30363d; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #21262d; color: #94a3b8; padding: 10px 4px; text-align: left; font-size: 11px; text-transform: uppercase; }
        td { padding: 10px 4px; border-bottom: 1px solid #30363d; vertical-align: middle; }
        
        .flight-no { font-weight: 800; color: #38bdf8; font-size: 15px; }
        .route-text { font-weight: 800; color: #fbbf24; font-size: 13px; display: block; }
        .time-group { display: flex; flex-direction: column; line-height: 1.3; min-width: 60px; } 
        .real-time { margin-top: 4px; font-weight: bold; color: #4ade80; font-size: 13px; }
        .status-pill { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 900; text-align: center; min-width: 80px; margin-left: 8px; }
        
        .st-completed { background-color: #d4edda; color: #155724; } 
        .st-plan { background-color: #334155; color: #94a3b8; }      
        .st-live { background-color: #00FFFF; color: #000; animation: blinker 2s infinite; } 
        @keyframes blinker { 50% { opacity: 0.6; } }
        
        .pair-blue { background: rgba(14, 165, 233, 0.15); border-left: 3px solid #0ea5e9; }
        .pair-brown { background: rgba(245, 158, 11, 0.1); border-left: 3px solid #f59e0b; }
        .standalone { background: #ffff00 !important; border-left: 4px solid #ff0000; }
        .standalone td, .standalone .flight-no, .standalone .route-text, .standalone div, .standalone span { color: #ff0000 !important; }
        .type-indicator { font-size: 9px; padding: 2px 4px; border-radius: 3px; margin-right: 4px; font-weight: bold; }
        .type-arr { background: #1e40af; color: #bfdbfe; }
        .type-dep { background: #166534; color: #bbf7d0; }
        .arr-cell-content { display: flex; align-items: center; justify-content: flex-start; }
    </style>
</head>
<body>

    <h2>RADAR LIVE (VIEW ONLY)</h2>

    <div class="summary-bar">
        <span id="update-status" class="update-time">ƒêang k·∫øt n·ªëi JSONBin...</span>
        <span id="total-flights" class="total-text">-- chuy·∫øn</span>
    </div>

    <div class="table-wrapper">
        <table>
            <thead><tr><th style="text-align:center">#</th><th>Chuy·∫øn/Reg</th><th>L·ªô tr√¨nh/Time</th><th>C·∫§T C√ÅNH</th><th>H·∫† C√ÅNH</th></tr></thead>
            <tbody id="flight-data"></tbody>
        </table>
    </div>

    <script>
        // === C·∫§U H√åNH JSONBIN (VIEWER - AN TO√ÄN) ===
        const JSONBIN_BIN_ID = "6987feeb43b1c97be96dcbb9";
        // ƒê√¢y l√† Read-Only Access Key anh v·ª´a cung c·∫•p
        const JSONBIN_API_KEY = "$2a$10$E020cSPDeHQd0G9ytrUj3u1YSFJN0d9sP3X0B38kOk.sZoVNqZn8K";
        // ============================================

        function renderTable(rawFlights) {
            const listDiv = document.getElementById('flight-data');
            if (!rawFlights || rawFlights.length === 0) {
                listDiv.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#aaa">Ch∆∞a c√≥ d·ªØ li·ªáu chia s·∫ª...</td></tr>';
                document.getElementById('total-flights').innerText = "0 chuy·∫øn";
                return;
            }

            rawFlights.sort((a,b) => a.raw_sort_time - b.raw_sort_time);

            let groups = []; let used = new Set();
            // LOGIC GH√âP C·∫∂P (H√£ng + S·ªë l·ªách 1 + Route ng∆∞·ª£c)
            rawFlights.forEach(f => {
                const fId = f.flight + "_" + f.raw_sort_time + "_" + f.type;
                if (used.has(fId)) return;
                let currentGroup = [f]; used.add(fId);
                if (f.type === 'arr') {
                    const pair = rawFlights.find(p => {
                        const pId = p.flight + "_" + p.raw_sort_time + "_" + p.type;
                        if (p.type !== 'dep' || used.has(pId)) return false;
                        if (f.o_iata !== p.d_iata || f.d_iata !== p.o_iata) return false;
                        const fMatch = f.flight.match(/^([A-Z0-9]{2})(\d+)$/);
                        const pMatch = p.flight.match(/^([A-Z0-9]{2})(\d+)$/);
                        if (fMatch && pMatch) {
                            const fCode = fMatch[1]; const fNum = parseInt(fMatch[2]);
                            const pCode = pMatch[1]; const pNum = parseInt(pMatch[2]);
                            if (fCode === pCode && Math.abs(fNum - pNum) === 1) return true;
                        }
                        return false;
                    });
                    if (pair) { currentGroup.push(pair); used.add(pair.flight + "_" + pair.raw_sort_time + "_" + pair.type); }
                }
                groups.push(currentGroup);
            });

            document.getElementById('total-flights').innerText = `T·ªïng: ${rawFlights.length} chuy·∫øn`;
            let html = ""; let stt = 1; let pIdx = 0;
            
            groups.forEach(group => {
                const colorClass = group.length > 1 ? (pIdx++ % 2 === 0 ? "pair-blue" : "pair-brown") : "standalone";
                group.forEach(f => {
                    let stClass = "st-plan", icon = "‚úàÔ∏è";
                    if (f.status === "FLYING") { stClass = "st-live"; icon = "üõ´"; }
                    if (f.status === "LANDED") { stClass = "st-completed"; icon = "üõ¨"; }
                    
                    // --- LOGIC HI·ªÇN TH·ªä E/A (CHU·∫®N A.115: ∆Øu ti√™n Real -> Est) ---
                    
                    // 1. Departure
                    let depDisplay = "";
                    if (f.dep_real && f.dep_real !== "--:--") {
                        depDisplay = `<span class="real-time">A: ${f.dep_real}</span>`;
                    } else if (f.dep_est && f.dep_est !== "--:--") {
                        depDisplay = `<span class="real-time">E: ${f.dep_est}</span>`;
                    }

                    // 2. Arrival
                    let arrDisplay = "";
                    if (f.arr_real && f.arr_real !== "--:--") {
                        arrDisplay = `<span class="real-time">A: ${f.arr_real}</span>`;
                    } else if (f.arr_est && f.arr_est !== "--:--") {
                        arrDisplay = `<span class="real-time">E: ${f.arr_est}</span>`;
                    }

                    html += `<tr class="${colorClass}">
                        <td style="text-align:center; font-weight:bold; color:#94a3b8">${stt++}</td>
                        <td><span class="flight-no">${f.flight}</span><span style="color:#facc15; font-weight:bold; display:block; font-size:12px">${f.reg}</span></td>
                        <td><div class="route-text"><span class="type-indicator type-${f.type}">${f.type==='arr'?'ƒê·∫æN':'ƒêI'}</span> ${f.o_iata}-${f.d_iata}</div><div style="font-size:10px; color:#94a3b8">${f.aircraft} | ‚è±${f.flight_time}</div></td>
                        <td><div class="time-group"><span style="font-size:11px; color:#94a3b8">S: ${f.dep_sched || '--:--'}</span>${depDisplay}</div></td>
                        <td><div class="arr-cell-content"><div class="time-group"><span style="font-size:11px; color:#94a3b8">S: ${f.arr_sched || '--:--'}</span>${arrDisplay}</div><div class="status-pill ${stClass}">${icon} ${f.status}</div></div></td>
                    </tr>`;
                });
            });
            listDiv.innerHTML = html;
        }

        function syncData() {
            document.getElementById('update-status').innerText = "ƒêang ƒë·ªìng b·ªô...";
            
            fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
                headers: { 'X-Master-Key': JSONBIN_API_KEY }
            })
            .then(response => response.json())
            .then(data => {
                // JSONBin tr·∫£ v·ªÅ data n·∫±m trong obj 'record'
                if (data && data.record && data.record.flights) {
                    renderTable(data.record.flights);
                    document.getElementById('update-status').innerText = `C·∫≠p nh·∫≠t: ${data.record.updated || 'V·ª´a xong'}`;
                }
            })
            .catch(err => {
                console.log(err);
                document.getElementById('update-status').innerText = "L·ªói k·∫øt n·ªëi!";
            });
        }

        // T·ª± ƒë·ªông t·∫£i l·∫°i m·ªói 10 gi√¢y
        syncData();
        setInterval(syncData, 10000);

    </script>
</body>
</html>
